<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Test</title>
  <link rel="stylesheet" type="text/css" href="style.css">
  <script type="text/javascript" src="script.js"></script>
  <script type="text/javascript" src="targetclient.browser.js"></script>
</head>
<body>
  <div id="result"></div>
  <script type="text/javascript">

    const queryString = window.location.search;
    const urlParams = new URLSearchParams(queryString);

    const doLocalDecisioning = urlParams.get('local') !== null;

    let client;

    const context = {
      "channel": "web",
      "mobilePlatform": null,
      "application": null,
      "screen": null,
      "window": null,
      "browser": null,
      "address": {
        "url": "http://adobe.com",
        "referringUrl": null
      },
      "geo": null,
      "timeOffsetInMinutes": null,
      "userAgent": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:73.0) Gecko/20100101 Firefox/73.0",
      "beacon": false
    };

    const visitorId = {
      "tntId": "338e3c1e51f7416a8e1ccba4f81acea0.28_0",
      "marketingCloudVisitorId": "07327024324407615852294135870030620007",
    };

    const targetRequest = {
      "id": visitorId,
      "context": context
    };

    function getOffers() {

      client.getOffers({
        request: {
          ...targetRequest,
          prefetch: {
            mboxes: [
              {
                name: "jason-flags",
                index: 2
              }
            ]
          }
        },
        sessionId: "dummy_session"
      }).then(function(res) {
        showResult("Result: Success", JSON.stringify(res, null, 4));
      }).catch(function(err) {
        showResult("Result: Error", err.toString());
      });

      client.getAttributes(['jason-flags'], {
        request: targetRequest,
        sessionId: "dummy_session"
      }).then(function(features) {
        console.log(features.asObject('jason-flags'));
        console.log(features.getValue('jason-flags', 'paymentExperience'));
      });

    }

    const targetClientOptions = {
      client: "adobesummit2018",
      organizationId: "65453EA95A70434F0A495D34@AdobeOrg",
      clientReadyCallback: getOffers
    };

    client = window.TargetClient.create(Object.assign({}, targetClientOptions, doLocalDecisioning ? {
      executionMode: "local",
      artifactLocation: "https://target-local-decisioning-test.s3.us-west-2.amazonaws.com/adobesummit2018/waters_test/jasonsflags-rules.json",
    } : {}));
  </script>
</body>
</html>
